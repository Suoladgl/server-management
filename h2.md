# H2 Package-File-Service

aloitin tehtävän luomalla apachelle oman moduulin /srv/salt directoryyn.

    $ cd /srv/salt
  
    /srv/salt$ sudo mkdir apache

Sitten loin init.sls tiedoston apache directoryyn. 

    /srv/salt$ cd apache
  
    /srv/salt/apache$ sudoedit init.sls
    
jonka sisään kirjoitin ensin 

    apache2:
      pkg.installed
     
ja testasin että toimii.

    $ sudo salt '*' state.apply apache
  
sain vastaukseksi, että 1 onnistunut, yhdellä muutoksella. Joten testasin, että apache asennus on onnistunut slavella.
komennolla:

    $ sudo salt '*' cmd.run 'service apache2 start'
  
josta ei tullut vastausta, mutta apache pyörii localhostissa.

Tämän testasin firefoxilla yhdistämällä localhostiin, esille tuli apache2 ubuntu default page.

Testasin vielä aikaisemman komennon toimintaa antamalla komennon

    $ sudo salt '*' cmd.run 'service apache2 stop'
  
jonka jälkeen localhost ei vastannut - johtopäätös: komento toimii. Laitetaan apache takaisin päälle.

    $ sudo salt '*' cmd.run 'service apache2 start'

Eli nyt Apache saatiin asennettua saltilla ja se käynnistettiin manuaalisesti saltin avulla. Voidaan todeta että pkg.installed toimii.



## OpenSSH server
Päätin koittaa asentaa ssh demonin salt minionille.

Aloitin tehtävän luomalla OpenSSH:lle oman moduulin /srv/salt directoryyn.

    $ cd /srv/salt
  
    /srv/salt$ sudo mkdir openssh

Sitten loin init.sls tiedoston openssh directoryyn. 

    /srv/salt$ cd openssh
  
    /srv/salt/apache$ sudoedit init.sls
    
jonka sisään kirjoitin ensin 

    openssh-server:
      pkg.installed
     
ja testasin että toimii.

    $ sudo salt '*' state.apply openssh


    ID: openssh-server
    Function: pkg.installed
    Result: True
    Succeeded: 1 (changed=1)
    Failed:    0

Open SSH saatiin asennettua saltilla, nyt se pitää potkaista päälle ja konfiguroida.

    $ sudo salt '*' cmd.run 'systemctl enable ssh'
    noop:
    Synchronizing state of ssh.service with SysV service script with /lib/systemd/systemd-sysv-install.
    Executing: /lib/systemd/systemd-sysv-install enable ssh
    
    $ sudo salt '*' cmd.run 'systemctl start ssh'
    noop:
Sitten testataan yhteyttä ssh palvelimeen.   

    $ ssh aatu@noop
    The authenticity of host 'noop (127.0.1.1)' can't be established.
    ECDSA key fingerprint is SHA256:DhoSg+/YXE7isGFzfrq9+oYFanMulBiZngpd2mTQXlQ.
    Are you sure you want to continue connecting (yes/no)? 
    yes
    aatu@noop's password: 
    Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-52-generic x86_64)

     * Documentation:  https://help.ubuntu.com
     * Management:     https://landscape.canonical.com
     * Support:        https://ubuntu.com/advantage

     * Introducing self-healing high availability clustering for MicroK8s!
       Super simple, hardened and opinionated Kubernetes for production.

         https://microk8s.io/high-availability

     * Canonical Livepatch is available for installation.
       - Reduce system reboots and improve kernel security. Activate at:
         https://ubuntu.com/livepatch

    24 packages can be updated.
    1 update is a security update.

    Your Hardware Enablement Stack (HWE) is supported until April 2023.
    *** System restart required ***

    The programs included with the Ubuntu system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
    applicable law.
Yhteys toimii.

Aika tehdä tästä kunnon Package-File-Service tyyppinen asennus. Palasin takaisin /srv/salt/openssh/init.sls tiedoston muokkaamiseen.

    ~$ sudoedit /srv/salt/openssh/init.sls 
    openssh-server:
      pkg.installed
    /etc/ssh/sshd_config:
      file.managed:
        - source: salt://openssh/sshd_config
    sshd:       
      service.running:
        - watch:
          - file: /etc/ssh/sshd_config


kopioin sshd_config tiedoston srv/salt/openssh directoryyn, ja editoin siihen alkuun testi kommentin.

    $ sudo cp /etc/ssh/sshd_config  /srv/salt/openssh/sshd_config
    $ sudoedit /srv/salt/openssh/sshd_config
    #       $OpenBSD: sshd_config,v 1.101 2017/03/14 07:19:07 djm Exp $
    # testikommentti
    ...
    
Eli nyt openssh on asennettu Package-File-Service muodossa, ensin asennetaan package, muutetaan file ja käynnistetään service, watch komento restarttaa servicen annetun kondition mukaan, tässä se on kyseinen sshd_config file.

Aika testata, eli antaa state.apply komento:

    $ sudo salt '*' state.apply openssh
    noop:
    ----------
          ID: openssh-server
    Function: pkg.installed
      Result: True
     Comment: All specified packages are already installed
     Started: 20:20:13.327295
    Duration: 850.075 ms
     Changes:   
    ----------
          ID: /etc/ssh/sshd_config
    Function: file.managed
      Result: True
     Comment: File /etc/ssh/sshd_config updated
     Started: 20:20:14.179911
    Duration: 14.933 ms
     Changes:   
              ----------
              diff:
                  --- 
                  +++ 
                  @@ -1,4 +1,5 @@
                   #	$OpenBSD: sshd_config,v 1.101 2017/03/14 07:19:07 djm Exp $
                  +# testikommentti
                   
                   # This is the sshd server system-wide configuration file.  See
                   # sshd_config(5) for more information.
    ----------
          ID: sshd
    Function: service.running
      Result: True
     Comment: Service restarted
     Started: 20:20:14.221136
    Duration: 30.844 ms
     Changes:   
              ----------
              sshd:
                  True

    Summary for noop
    ------------
    Succeeded: 3 (changed=2)
    Failed:    0
    ------------
    Total states run:     3
    Total run time: 895.852 ms    

Tämän mukaan kaikki toimi kuten pitikin. Openssh oli jo asennettu joten siihen ei tullut muutosta, sshd_config tiedosto päivitettiin ja täten myös service restartattiin. 
















lähteet: https://docs.saltstack.com/en/master/topics/tutorials/states_pt2.html ja https://terokarvinen.com/
